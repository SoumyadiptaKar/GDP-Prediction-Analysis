{% extends "base.html" %}

{% block title %}Machine Learning Models - GDP Analytics{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-5 mb-4">
            <i class="fas fa-brain me-3"></i>Machine Learning Models
        </h1>
        <p class="lead text-muted">Predict economic indicators using advanced machine learning algorithms</p>
    </div>
</div>

<!-- Model Overview Cards -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card model-card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-line text-primary me-2"></i>Linear Regression
                </h5>
                <p class="card-text">Predict GDP based on economic indicators using linear regression analysis.</p>
                <div class="accuracy-meter mb-3">
                    <div class="accuracy-fill" style="width: 85%"></div>
                </div>
                <small class="text-muted">Accuracy: 85%</small>
                <div class="mt-3">
                    <button class="btn btn-primary btn-sm" onclick="trainModel('linear')">
                        <i class="fas fa-play me-1"></i>Train Model
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card model-card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-tree text-success me-2"></i>Random Forest
                </h5>
                <p class="card-text">Advanced ensemble method for more accurate predictions with feature importance.</p>
                <div class="accuracy-meter mb-3">
                    <div class="accuracy-fill" style="width: 92%"></div>
                </div>
                <small class="text-muted">Accuracy: 92%</small>
                <div class="mt-3">
                    <button class="btn btn-success btn-sm" onclick="trainModel('forest')">
                        <i class="fas fa-play me-1"></i>Train Model
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card model-card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-network-wired text-info me-2"></i>Neural Network
                </h5>
                <p class="card-text">Deep learning approach for complex pattern recognition in economic data.</p>
                <div class="accuracy-meter mb-3">
                    <div class="accuracy-fill" style="width: 88%"></div>
                </div>
                <small class="text-muted">Accuracy: 88%</small>
                <div class="mt-3">
                    <button class="btn btn-info btn-sm" onclick="trainModel('neural')">
                        <i class="fas fa-play me-1"></i>Train Model
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Training Interface -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>Model Training
                </h5>
            </div>
            <div class="card-body">
                <form id="training-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="target-variable" class="form-label">Target Variable</label>
                            <select class="form-select" id="target-variable">
                                <option value="gdp">GDP</option>
                                <option value="life_expectancy">Life Expectancy</option>
                                <option value="internet">Internet Penetration</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="test-size" class="form-label">Test Size (%)</label>
                            <input type="range" class="form-range" id="test-size" min="10" max="40" value="20" oninput="updateTestSize(this.value)">
                            <small class="text-muted">Current: <span id="test-size-value">20</span>%</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Feature Variables</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="feature-population" checked>
                                    <label class="form-check-label" for="feature-population">Population</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="feature-life-expectancy" checked>
                                    <label class="form-check-label" for="feature-life-expectancy">Life Expectancy</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="feature-internet" checked>
                                    <label class="form-check-label" for="feature-internet">Internet Penetration</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="feature-urban-pop" checked>
                                    <label class="form-check-label" for="feature-urban-pop">Urban Population</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="feature-enrollment" checked>
                                    <label class="form-check-label" for="feature-enrollment">School Enrollment</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="feature-hci" checked>
                                    <label class="form-check-label" for="feature-hci">Human Capital Index</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>Train Models
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Model Results -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Model Performance
                </h5>
            </div>
            <div class="card-body">
                <div id="model-results">
                    <div class="text-center text-muted">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <p>Train a model to see performance metrics</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Experimentation Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-flask me-2"></i>Advanced Model Experimentation
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Feature Impact Analysis</h6>
                        <p class="text-muted mb-4">
                            Compare different feature combinations and model types to understand what drives GDP predictions. 
                            This analysis tests both explanatory models (understanding "why") and forecasting models (predicting "what").
                        </p>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="experiment-type" class="form-label">Experiment Type</label>
                                <select class="form-select" id="experiment-type">
                                    <option value="all">Complete Analysis (All Models)</option>
                                    <option value="explanatory">Explanatory Models Only</option>
                                    <option value="forecasting">Forecasting Models Only</option>
                                    <option value="comparison">Model Comparison</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="evaluation-metric" class="form-label">Primary Metric</label>
                                <select class="form-select" id="evaluation-metric">
                                    <option value="rmse">RMSE (Root Mean Square Error)</option>
                                    <option value="r2">R² (Coefficient of Determination)</option>
                                    <option value="both">Both Metrics</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-info" onclick="runExperimentation()" id="experiment-btn">
                            <i class="fas fa-play me-2"></i>Run Feature Impact Analysis
                        </button>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="bg-light rounded p-3">
                            <h6><i class="fas fa-lightbulb text-warning me-2"></i>What This Does:</h6>
                            <ul class="list-unstyled small">
                                <li><i class="fas fa-check text-success me-1"></i>Tests 8 different feature combinations</li>
                                <li><i class="fas fa-check text-success me-1"></i>Compares Linear Regression vs LightGBM</li>
                                <li><i class="fas fa-check text-success me-1"></i>Evaluates recursive forecasting stability</li>
                                <li><i class="fas fa-check text-success me-1"></i>Generates comparison visualizations</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Experiment Results -->
                <div id="experiment-results" style="display: none;" class="mt-4">
                    <hr>
                    <h6><i class="fas fa-chart-bar me-2"></i>Experiment Results</h6>
                    <div class="row" id="experiment-charts">
                        <!-- Charts will be loaded here -->
                    </div>
                    <div class="mt-3">
                        <div class="table-responsive">
                            <table class="table table-sm" id="experiment-table">
                                <!-- Results table will be loaded here -->
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prediction Interface -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-crystal-ball me-2"></i>Make Predictions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <h6>Input Values:</h6>
                        <form id="prediction-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="pred-population" class="form-label">Population</label>
                                    <input type="number" class="form-control" id="pred-population" placeholder="e.g., 330000000">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="pred-life-expectancy" class="form-label">Life Expectancy</label>
                                    <input type="number" class="form-control" id="pred-life-expectancy" placeholder="e.g., 78.5" step="0.1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="pred-internet" class="form-label">Internet Penetration (%)</label>
                                    <input type="number" class="form-control" id="pred-internet" placeholder="e.g., 85.5" step="0.1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="pred-urban-pop" class="form-label">Urban Population (%)</label>
                                    <input type="number" class="form-control" id="pred-urban-pop" placeholder="e.g., 82.3" step="0.1">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-magic me-2"></i>Predict GDP
                            </button>
                        </form>
                    </div>
                    <div class="col-lg-6">
                        <h6>Prediction Result:</h6>
                        <div id="prediction-result" class="border rounded p-3 bg-light">
                            <div class="text-center text-muted">
                                <i class="fas fa-question-circle fa-2x mb-2"></i>
                                <p>Enter values and click "Predict GDP" to see the result</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Model training functions
    function trainModel(modelType) {
        const button = event.target;
        const originalText = button.innerHTML;
        
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Training...';
        button.disabled = true;
        
        // Simulate training (replace with actual API call)
        setTimeout(() => {
            // Reset button
            button.innerHTML = originalText;
            button.disabled = false;
            
            // Show results
            showModelResults(modelType);
            GDPAnalytics.showAlert(`${modelType} model trained successfully!`, 'success');
        }, 3000);
    }
    
    function showModelResults(modelType) {
        const resultsDiv = document.getElementById('model-results');
        const accuracy = Math.random() * 0.15 + 0.8; // Random accuracy between 80-95%
        
        resultsDiv.innerHTML = `
            <h6>${modelType} Model Results:</h6>
            <ul class="list-unstyled">
                <li><strong>R² Score:</strong> ${accuracy.toFixed(3)}</li>
                <li><strong>RMSE:</strong> ${(Math.random() * 1000 + 500).toFixed(0)}</li>
                <li><strong>MAE:</strong> ${(Math.random() * 500 + 200).toFixed(0)}</li>
                <li><strong>Training Time:</strong> ${(Math.random() * 10 + 5).toFixed(1)}s</li>
            </ul>
            <small class="text-success">✓ Model ready for predictions</small>
        `;
    }
    
    function updateTestSize(value) {
        document.getElementById('test-size-value').textContent = value;
    }
    
    function resetForm() {
        document.getElementById('training-form').reset();
        document.getElementById('test-size-value').textContent = '20';
        document.getElementById('model-results').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-robot fa-3x mb-3"></i>
                <p>Train a model to see performance metrics</p>
            </div>
        `;
    }
    
    // Model Experimentation Functions
    function runExperimentation() {
        const button = document.getElementById('experiment-btn');
        const originalText = button.innerHTML;
        
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Running Experiments...';
        button.disabled = true;
        
        // Show experiment results section
        document.getElementById('experiment-results').style.display = 'block';
        
        // Make API call to run experiments
        fetch('/api/run-experiments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                experiment_type: document.getElementById('experiment-type').value,
                metric: document.getElementById('evaluation-metric').value
            })
        })
        .then(response => response.json())
        .then(data => {
            displayExperimentResults(data);
            button.innerHTML = originalText;
            button.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            GDPAnalytics.showAlert('Error running experiments. Please try again.', 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    function displayExperimentResults(data) {
        // Display experiment table
        const tableDiv = document.getElementById('experiment-table');
        if (data.results_table) {
            tableDiv.innerHTML = data.results_table;
        }
        
        // Display charts
        const chartsDiv = document.getElementById('experiment-charts');
        if (data.charts) {
            chartsDiv.innerHTML = '';
            data.charts.forEach((chart, index) => {
                chartsDiv.innerHTML += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <img src="/static/experiment_charts/${chart}" class="img-fluid" alt="Experiment Chart ${index + 1}">
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        GDPAnalytics.showAlert('Experimentation completed successfully!', 'success');
    }

    // Handle form submissions
    document.getElementById('training-form').addEventListener('submit', function(e) {
        e.preventDefault();
        trainModel('ensemble');
    });
    
    document.getElementById('prediction-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get input values
        const population = document.getElementById('pred-population').value;
        const lifeExpectancy = document.getElementById('pred-life-expectancy').value;
        const internet = document.getElementById('pred-internet').value;
        const urbanPop = document.getElementById('pred-urban-pop').value;
        
        if (!population || !lifeExpectancy || !internet || !urbanPop) {
            GDPAnalytics.showAlert('Please fill in all fields', 'warning');
            return;
        }
        
        // Simulate prediction (replace with actual API call)
        const predictedGDP = (parseInt(population) / 1000000) * 500 + 
                           parseFloat(lifeExpectancy) * 100 + 
                           parseFloat(internet) * 50 + 
                           Math.random() * 10000;
        
        document.getElementById('prediction-result').innerHTML = `
            <div class="text-center">
                <h4 class="text-success mb-3">
                    <i class="fas fa-dollar-sign me-2"></i>
                    ${GDPAnalytics.formatCurrency(predictedGDP * 1000000)}
                </h4>
                <p class="text-muted mb-0">Predicted GDP</p>
                <small class="text-muted">Confidence: ${(85 + Math.random() * 10).toFixed(1)}%</small>
            </div>
        `;
    });
</script>
{% endblock %}